BEGIN;

-- Fix typo in function name
ALTER FUNCTION sceduled_mode(ts TIMESTAMP WITH TIME ZONE, tz TEXT) RENAME TO scheduled_mode;

CREATE OR REPLACE FUNCTION incoming_route(msg HSTORE) RETURNS TABLE(field TEXT, value TEXT) AS $$
DECLARE
	m TEXT;
BEGIN
	m := scheduled_mode();
	RETURN QUERY SELECT 'location'::TEXT, 'lateroute/' || route FROM incoming
		WHERE (ctx IS NULL OR ctx = msg->'context')
			AND (called IS NULL OR called = msg->'called')
			AND (mode IS NULL OR mode = m)
		ORDER BY ctx IS NULL, called IS NULL, mode IS NULL LIMIT 1;
END;
$$ LANGUAGE PlPgSQL;

-- missing indices
CREATE UNIQUE INDEX users_num_index ON users(num);

-- calls log
CREATE TABLE callog(
	id BIGSERIAL PRIMARY KEY,
	ts TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
	billid TEXT NOT NULL,
	tag TEXT,
	uid INTEGER NULL REFERENCES users(id) ON DELETE SET NULL,
	value TEXT NULL,
	params HSTORE NULL
);
CREATE INDEX callog_ts_index ON callog(ts);
CREATE INDEX callog_billid_index ON callog(billid);
CREATE INDEX callog_tag_index ON callog(tag);

-- config
CREATE TABLE config (
	id SERIAL PRIMARY KEY,
	section TEXT NOT NULL,
	params HSTORE NOT NULL,
	ts TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
	uid INTEGER NULL REFERENCES users(id) ON DELETE SET NULL
);
CREATE UNIQUE INDEX config_section_index ON config(section);

CREATE OR REPLACE FUNCTION config(section_name TEXT) RETURNS HSTORE AS $$
	SELECT params FROM config WHERE section = $1;
$$ LANGUAGE SQL STABLE;






COMMIT;

-- vim: ft=sql


